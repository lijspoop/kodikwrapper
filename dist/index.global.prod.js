"use strict";var KodikWrapper=(()=>{var m=Object.defineProperty;var I=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var k=(o,t)=>m(o,"name",{value:t,configurable:!0});var j=(o,t)=>{for(var e in t)m(o,e,{get:t[e],enumerable:!0})},V=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of S(t))!v.call(o,s)&&s!==e&&m(o,s,{get:()=>t[s],enumerable:!(n=I(t,s))||n.enumerable});return o};var _=o=>V(m({},"__esModule",{value:!0}),o);var A={};j(A,{Client:()=>L,ClientError:()=>l,KODIK_API_URL:()=>K,KODIK_PLAYER_DOMAIN:()=>E,KODIK_VIDEO_INFO_ENDPOINT:()=>b,VideoLinks:()=>w,VideoLinksError:()=>a,kodikPlayerLinkRegexp:()=>y});var a=class extends Error{static{k(this,"VideoLinksError")}code;stack;data;cause;constructor({code:t,description:e,data:n,cause:s}){super(e),this.code=t,this.data=n,this.name=this.constructor.name,this.cause=s,Error.captureStackTrace(this,this.constructor)}get[Symbol.toStringTag](){return this.constructor.name}toJSON(){let t={};for(let e of Object.getOwnPropertyNames(this))t[e]=this[e];return t}};var K="https://kodikapi.com",R=["countries","genres","list","qualities","search","translations","years","qualitiesV2","translationsV2"],U={qualitiesV2:"qualities/v2",translationsV2:"translations/v2"},l=class extends Error{static{k(this,"ClientError")}name="ClientError"},L=class o{static{k(this,"Client")}KODIK_API_URL;constructor({token:t,kodikApiUrl:e}){this.KODIK_API_URL=e??K;for(let n of R){let s=U[n]??n;this[n]=h=>fetch(new URL(`${s}?${new URLSearchParams({token:t,...h}).toString()}`,this.KODIK_API_URL),{method:"POST"}).then(async i=>{if(i.headers.get("content-type")!=="application/json")throw new l(`invalid response (expected content-type application/json, but got ${i.headers.get("content-type")})`);let r=await i.json();if(typeof r!="object")throw new l(`expected json as an object, but got a ${typeof r}`);return r}).then(i=>{if("error"in i)throw new l(i.error);return i})}}static fromToken(t,e){return new o({...e,token:t})}};var E="kodik.info",b="/ftor",y=/^(?<protocol>http[s]?:|)\/\/(?<host>[a-z0-9]+\.[a-z]+)\/(?<type>[a-z]+)\/(?<id>\d+)\/(?<hash>[0-9a-z]+)\/(?<quality>\d+p)(?:.*)$/,w=class o{static{k(this,"VideoLinks")}static async parseLink({extended:t,link:e}){if(!e)throw new a({code:"parse-link-invalid",description:"link is not provided",data:{link:e}});let n=this.normalizeKodikLink(e);if(!y.test(e))throw new a({code:"parse-link-invalid",description:"link is not valid",data:{link:e}});let s=y.exec(n).groups,{host:h,hash:i,id:r,quality:d,type:f}=s,x={host:h,hash:i,id:r,quality:d,type:f};if(!t)return x;let c=await fetch(n).then(O=>O.text()),g=c.match(/var\s+urlParams\s*=\s*'(?<urlParams>[^']+)';/)?.groups?.urlParams,u=c.match(/var\s+translationId\s*=\s*(?<id>\d+);\s*var\s+translationTitle\s*=\s*"(?<title>[^"]+)";/is)?.groups,P=c.match(/parseSkipButtons?\("(?<data>[^"]+)"\s*,\s*"(?<type>[^"]+)"\)/is)?.groups,p=c.match(/src="(?<link>\/assets\/js\/app\.player_single\.[a-z0-9]+\.js)"/is)?.groups?.link;if(!g)throw new a({code:"parse-link-ex-invalid",description:"cannot get url params",data:{link:e,page:c}});if(!u)throw new a({code:"parse-link-ex-invalid",description:"cannot get translation",data:{link:e,page:c}});return{...x,ex:{urlParams:JSON.parse(g),translation:{id:+u.id,title:u.title},skipButtons:{...P},playerSingleUrl:p}}}static normalizeKodikLink(t){return t.startsWith("//")?`https:${t}`:t.startsWith("http")?t:new URL(t,`https://${E}`).toString()}static async getActualVideoInfoEndpoint(t){let e=await fetch(this.normalizeKodikLink(t)).then(s=>s.text());return atob(e.match(/type:"POST",url:atob\("(?<b64str>[^"]+)"\)/i)?.groups?.b64str??"")||"/kor"}static async getLinks({link:t,videoInfoEndpoint:e=b}){let{host:n,quality:s,...h}=await o.parseLink({link:t}),i=new URL(`${e}?${new URLSearchParams(h).toString()}`,`https://${n}`),r=await fetch(i);if(r.headers.get("content-type")!=="application/json")throw new a({code:"get-links-invalid-response",description:"videoInfoResponse is not json",data:{videoInfoResponse:r}});let d=await r.json();if(typeof d!="object"||d===null)throw new a({code:"get-links-invalid-response",description:"videoInfoJson is not object",data:{videoInfoResponse:r,videoInfoJson:d}});if(typeof d.links!="object")throw new a({code:"get-links-invalid-response",description:"videoInfoJson.links is not object",data:{videoInfoResponse:r,videoInfoJson:d}});let f=d.links,x=90;for(let[,c]of Object.entries(f))for(let g of c){let u=g.src.replace(/[a-zA-Z]/g,P=>{let p=P.charCodeAt(0);return String.fromCharCode((p<=x?90:122)>=(p=p+13)?p:p-26)});g.src=atob(u)}return f}static parseSkipButtons=t=>t.data.split(",").map(e=>{let[n,s]=e.split("-");return{from:n,to:s}})};return _(A);})();
